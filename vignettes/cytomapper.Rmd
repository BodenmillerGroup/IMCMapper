---
title: "Spatial visualization for multiplexed imaging cytometry data in R"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('cytomapper')`"
author:
- name: Nils Eling
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nils.eling@dqbm.uzh.ch.com
- name: Nicolas Damond
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nicolas.damond@dqbm.uzh.ch.com
output:
  BiocStyle::html_document:
    toc_float: yes
bibliography: library.bib
abstract: |
    Highly multiplexed imaging cytometry acquires the single-cell expression of
    selected proteins in a spatially-resolved fashion. These measurements can be
    visualized across multiple length-scales. First, pixel-level intensities
    represent the spatial distributions of feature expression with highest
    resolution. Second, after segmentation, expression values or cell-level
    metadata (e.g. cell-type information) can be visualized on segmented cell
    areas. This package contains functions for the visualization of multiplexed
    read-outs and cell-level information obtained by multiplexed imaging
    cytometry. The main functions of this package allow 1. the visualization of
    pixel-level information across multiple channels and 2. the display of
    cell-level information (expression and/or metadata) on segmentation masks.
vignette: |
  %\VignetteIndexEntry{Spatial visualization for multiplexed imaging cytometry data in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE)
library(BiocStyle)
```

```{r library, echo=FALSE}
library(cytomapper)
```

# Introduction

This vignette gives an introduction to displaying highly multiplexed imaging cytometry data with the `cytomapper` package.
As an example, these instructions display imaging mass cytometry (IMC) data.
However, other imaging cytometry approaches including multiplexed ion beam imaging (MIBI) [@angelo2014mibi], tissue-based cyclic immunofluorescence (t-CyCIF) [@lin2018cycif] and iterative indirect immunofluorescence imaging (4i) [@gut20184i], which produce pixel-level intensities and optionally segmentation masks can be displayed using `cytomapper`.

IMC [@giesen2014imc] is a multiplexed imaging approach to measure spatial protein abundance.
In IMC, tissue sections are stained with a mix of $\tilde{}40$ metal-conjugated antibodies prior to laser ablation with $1\mu{}m$ resolution. 
The ablated material is transferred to a mass cytometer for time-of-flight detection of the metal ions [@giesen2014imc][@mavropoulosimc]. 
In that way, hundreds of images (usually with an image size of around 1mm x 1mm) can be generated in a reasonable amount of time [@damond2019pancreas]. 

Raw IMC data are computationally processed using a segmentation pipeline (available at [https://github.com/BodenmillerGroup/ImcSegmentationPipeline](https://github.com/BodenmillerGroup/ImcSegmentationPipeline)). 
This pipeline produces image stacks containing the raw pixel values for up to 40 channels, segmentation masks containing the segmented cells, cell-level expression and metadata information as well as a number of image-level meta information.

Cell-level expression and metadata can be processed and read into a `SingleCellExperiment` class object.
For more information on the `SingleCellExperiment` object and how to create it, please see the `r Biocpkg("SingleCellExperiment")` package and the [Orchestrating Single-Cell Analysis with Bioconductor](https://osca.bioconductor.org/data-infrastructure.html#the-singlecellexperiment-class) workflow.

The `cytomapper` package provides a new `CytoImageList` class as a container for multiplexed images or segmentation masks.
For more information on this class, refer to the [CytoImageList](#CytoImageList) section.

The main functions of this package include `plotCells` and `plotPixels`.
The `plotCells` function requires the following object inputs to display cell-level information (expression and metadata):

1. a SingleCellExperiment object, which contains the cells' counts and metadata
2. an CytoImageList object containing the segmentation mask per image

The `plotPixels` function requires the following object inputs to display pixel-level expression information:

1. a `CytoImageList` object containing the pixel-level information per channel
2. (optionally) a `SingleCellExperiment` object, which contains the cells' counts and metadata
2. (optionally) a `CytoImageList` object containing the segmentation mask per image

# Quick start

The following section provides a quick example highlighting the functionality of `cytomapper`.
For detailed information on reading in the data, refer to the [Reading in data](#ReadingData) section.
More information on the required data format is provided in the [Data formats](#DataFormats) section.
In the first step, we will read in the provided [toy dataset](#ToyData)

```{r quickstart-load-data}
data(pancreasSCE)
data(pancreasImages)
data(pancreasMasks)
```

The `CytomImageList` object containing pixel-level intensities representing the ion counts for five proteins can be displayed using the `plotPixel` function:

```{r quickstart-plotPixels}
plotPixels(image = pancreasImages, colour_by = c("H3", "SMA", "CD44"))
```

For more details on image normalization, cell outlining, and other pixel-level manipulations, refer to the [Plotting pixel information](#PixelInfo) section.

The `CytoImageList` object containing segmentation masks that represent the cell areas on the image can be displayed using the `plotCells` function.
Only the segmentation masks are plotted when no other parameters are specified.

```{r quickstart-plotCells}
plotCells(mask = pancreasMasks)
```

To colour and/or outline segmentation masks, a `SingleCellExperiment`, an `img_id` and `cell_id` entry need to be specified:

```{r quickstart-plotCells-2}
plotCells(mask = pancreasMasks, object = pancreasSCE, cell_id = "CellNb", img_id = "ImageNb", colour_by = "SMA")
plotCells(mask = pancreasMasks, object = pancreasSCE, cell_id = "CellNb", img_id = "ImageNb", colour_by = "SMA", outline_by = "CellType")
plotCells(mask = pancreasMasks, object = pancreasSCE, cell_id = "CellNb", img_id = "ImageNb", colour_by = "CellType")
```

For more information on the data formats and requirements, refer to the following section.
More details on the `plotCells` function are provided in the [Plotting cell information](#CellInfo) section.

# Data formats {#DataFormats}

The `cytomapper` package combines objects of the `r Biocpkg("SingleCellExperiment")` class and the `CytoImageList` class (provided in `cytomapper`) to visualize cell- and pixel-level information.

In the main functions of the package, `image` refers to an `CytoImageList` object containing one or multiple multi-channel images where each channel represents the pixel-intensity of one selected marker (proteins in the case of IMC).
The entry `mask` refers to an `CytoImageList` object containing one or multiple segmentation masks.
Segmentation masks are defined as one-channel images containing integer values, which represent the cells' ids or 0 (background).
Finally, the `object` entry refers to a `SingleCellExperiment` class object that contains cell-specific expression values (in the `assay` slots) and cell-specific metadata in the `colData` slot.

To link information between the `SingleCellExperiment` and `CytoImageList` objects, two slots need to be specified:

* `img_id`: a single character indicating the `colData` (in the `SingleCellExperiment` object) and `elementMetadata` (in the `CytoImageList` object) entry that contains the image identifiers. These image ids have to match between the `SingleCellExperiment` object and the `CytoImageList` object.
* `cell_id`: a single character indicating the `colData` entry that contains the cell identifiers. These should be integer values corresponing to pixel-values in the segmentation masks.

The `img_id` and `cell_id` entry in the `SingleCellExperiment` object need to be accessible via: 

```{r image-cell-id-sce}
colData(pancreasSCE)[,"ImageNb"]
colData(pancreasSCE)[,"CellNb"]
```

The `img_id` entry in the `CytoImageList` object need to be accessible via: 

```{r image-cell-id-cil}
mcols(pancreasImages)[,"ImageNb"]
mcols(pancreasMasks)[,"ImageNb"]
```

For more information on the `CytoImageList` class, please refer to the section [The CytoImageList object](#CytoImageList).
For more information on the `SingleCellExperiment` object and how to create it, please see the `r Biocpkg("SingleCellExperiment")` package and the [Orchestrating Single-Cell Analysis with Bioconductor](https://osca.bioconductor.org/data-infrastructure.html#the-singlecellexperiment-class) workflow.

## The provided toy dataset {#ToyData}

For visualization purposes, the `cytomapper` package provides a toy dataset containing 3 images of $100\mu{m}$ x $100\mu{m}$ dimensions (100 x 100 pixels).
The dataset contains 282 segmented cells and the expression values for 5 proteins: H3, SMA, INS, CD38, and CD44
It represents a small subset of the data presented in [A Map of Human Type 1 Diabetes Progression by Imaging Mass Cytometry](Ahttps://www.cell.com/cell-metabolism/fulltext/S1550-4131(18)30691-0?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS1550413118306910%3Fshowall%3Dtrue).

Pixel-level intensities for all 5 markers (5 channels) are stored in the `pancreasImages` object.
Entires to the `CytoImageList` object and the rownames of the object match: A02_imc, D01_imc, and F01_imc
The `elementMetadata` slot (accesible via the `mcols()` function) contains the image identifiers.

```{r pancreasImages}
pancreasImages
mcols(pancreasImages)
channelNames(pancreasImages)
imageData(pancreasImages[[1]])[1:15,1:5,1]
```

The corresponding segmentation masks are stored in the `pancreasMasks` object.
Segmentation masks are defined as one-channel images containing integer values, which represent the cells' ids or 0 (background).

```{r pancreasMasks}
pancreasMasks
mcols(pancreasMasks)
imageData(pancreasMasks[[1]])[1:15,1:5]
```

All cell-specific metadata are stored in the `colData` slot of the corresponding `SingleCellExperiment` object: `pancreasSCE`.
For more information on the metadata, please refer to the `?pancreasSCE` documentation.
Of note: the cell-type labels contained in the `colData(pancreasSCE)$CellType` slot are randomized and do not represent biologically relevant cell-types.

```{r pancreasSCE}
pancreasSCE
names(colData(pancreasSCE))
```

The `pancreasSCE` object also contains further information on the measured proteins via the `rowData(pancreasSCE)` slot.
Furthermore, the `pancreasSCE` object contains the raw expression counts per cell in the form of mean pixel value per cell and protein (accessible via `counts(pancreasSCE)`).
The arcsinh-transformed (using a co-factor of 1) raw expression counts can be obtained via `assay(pancreasSCE, "exprs")`.

# Reading in data {#ReadingData}

The `cytomapper` package provides the `loadImages` function to conveniently read images into a `CytoImageList` object.

## Load images

The `loadImages` function returns a `CytoImageList` object containing the multi-channel images or segmentation masks.
Refer to the `?loadImages` function to see the full functionality.

As an example, we will read in multi-channel images and segmentation masks provided by the `cytomapper` package.

```{r read-in-images}
# Read in masks
path.to.images <- system.file("extdata", package = "cytomapper")
all_masks <- loadImages(path.to.images, pattern = "_mask.tiff")
all_masks

# Read in images
all_stacks <- loadImages(path.to.images, pattern = "_imc.tiff")
all_stacks
```

## Add metadata

To link images between the two `CytoImageList` objects and the corresponding `SingleCellExperiment` object, the image ids need to be added to the `elementMetadata` slot of the `CytoImageList` objects.
From the experimental setup, we know that the image named 'A02_imc' has image id '1', D01_imc has id '2', F01_imc has id '3'.

```{r add-metadata}
unique(pancreasSCE$ImageNb)
mcols(all_masks)$ImageNb <- c("1", "2", "3")
mcols(all_stacks)$ImageNb <- c("1", "2", "3")
```

## Scale images

We can see, that in some cases, the pixel-values are not correctly scaled by the image encoding.
The segmentation masks should only contain integer entries:

```{r image-encoding}
unique(as.numeric(all_masks[[1]]))
```

The provided data was processed using CellProfiler [@carpenter2006cellprofiler].
By default, CellProfiler scales all pixel intensities between 0 and 1. 
This is done by dividing each count by the maximum possible intensity value (see [MeasureObjectIntensity](https://cellprofiler-manual.s3.amazonaws.com/CellProfiler-3.0.0/modules/measurement.html#measureobjectintensity) for more info). 
In the case of 16-bit encoding (where 0 is a valid intensity), this scaling value is `2^16-1 = 65535`. 
Therefore, pixel-intensites need to be rescaled by this value.
However, this scaling value can change and different images can be scaled by different factors.
The user needs make sure to select the correct factors in more complex cases.

The `cytopmapper` package provides a `?scaleImages` function.
The user needs to manually scale images to obtain the correct pixel-values.
Here, we scale the segmentation masks by the factor for 16-bit encoding: `2^16-1`

```{r scaleImage-1}
all_masks <- scaleImages(all_masks, 2^16-1)
unique(as.numeric(all_masks[[1]]))
```

In this case, the multi-channel images are not affected by this scaling factor.

## Add channel names

To access the correct images in the multi-channel `CytoImageList` object, the user needs to set the correct channel names.
For this, the `cytomapper` package provides the `?channelNames` getter and setter function:

```{r channelNames-example}
channelNames(all_stacks) <- c("H3", "SMA", "INS", "CD38", "CD44")
```

The read-in data can now be used for visualization:

```{r example-viz}
plotPixels(all_stacks, colour_by = c("H3", "SMA", "CD44"))
plotCells(all_masks, object = pancreasSCE, cell_id = "CellNb", img_id = "ImageNb", colour_by = "CellType")
```

# The CytoImageList object {#CytoImageList}

This document also introduces the `CytoImageList` class, which inherits from the [`SimpleList` class](https://rdrr.io/bioc/S4Vectors/man/SimpleList-class.html).

Images should be stacks, all stacks should have the same number of channels
Masks should be single-channel images

Explain mcols

## Accessors

## Coercion

## Subsetting
Extract one channel from the CytoImageList

## Looping

# Plotting pixel information {#PixelInfo}

## Outline

## Normalization

However, pixel intensities can be normalized.
The `cytomapper` package provides a `normalize` (?`normalize,CytoImageList-method`) function to linearly scale images:

```{r normalize}

```

# Plotting cell information {#CellInfo}

# Customization

## Legend

## Scale bar

## Cropping

# Saving images

# Acknowledgements

# Contributions

Nicolas created cytomapper - Nicolas and Nils implemented the package ...

# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References

