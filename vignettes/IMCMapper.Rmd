---
title: "Spatial visualization for imaging mass cytometry data in R"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('IMCMapper')`"
author:
- name: Nils Eling
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nils.eling@dqbm.uzh.ch.com
- name: Nicolas Damond
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nicolas.damond@dqbm.uzh.ch.com
output:
  BiocStyle::html_document:
    toc_float: yes
bibliography: library.bib
abstract: |
  Imaging mass cytometry (IMC) is a multiplexed imaging approach that aquires
  the single-cell expression of up to 40 proteins in a spatially-resolved
  fashion. IMC measurements can be visualized across multiple length-scales.
  First, pixel-level intensities represent the spatial distributions of feature
  expression with highest resolution. Second, after segementation, expression
  values or cell-level metadata (e.g. cell-type information) can be visualized
  on segmented cell areas. This package contains functions for the visualization
  of multiplexed read-outs and cell-level information obtained by imaging mass
  cytometry. The main functions of this package allow 1. the visualization of
  pixel-level information across multiple channels and 2. the display of
  cell-level information (expression and/or metadata) on segmentation masks.
vignette: |
  %\VignetteIndexEntry{Spatial visualization for imaging mass cytometry data in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE)
library(BiocStyle)
```

```{r library, echo=FALSE}
library(IMCMapper)
```

# Introduction

This vignette gives an introduction to displaying imaging mass cytometry data with the `IMCMapper` package.
Imaging mass cytometry (IMC)[@giesen2014imc] is a multiplexed imaging approach to measure spatial protein abundance.
In IMC, tissue sections are stained with a mix of $\tilde{}40$ metal-conjugated antibodies prior to laser ablation with $1\mu{}m$ resolution. The ablated material is transferred to a mass cytometer for time-of-flight detection of the metal ions [@giesen2014imc][@mavropoulosimc]. In that way, hundreds of images (usually with an image size of up to $1\mu{}m$ x $1\mu{}m$) can be generated in a reasonable amount of time [@damond2019pancreas]. 

Raw IMC data are computationally processed using a segmentation pipeline (available at [https://github.com/BodenmillerGroup/ImcSegmentationPipeline](https://github.com/BodenmillerGroup/ImcSegmentationPipeline)). 
This pipeline produces image stacks containing the raw pixel values for up to 40 channels, segmentation masks containing the segmented cells, cell-level expression and metadata information as well as a number of image-level meta information.

Cell-level expression and metadata can be processed and read into a 

This document also introduces the `IMCImageList` class, which inherits from the [`SimpleList` class](https://rdrr.io/bioc/S4Vectors/man/SimpleList-class.html).

Explain: images, masks, sce

It requires three
  data objects for visualization: 1. a SingleCellExperiment object, which
  contains the cells' counts and metadata, 2. an IMCImageList object containing
  the pixel-level information per channel and 3. an IMCImageList object
  containing the segmentation mask per image. The main functionality of this
  package includes the individual or multiplexed visualization of pixel- and
  cell-level information for all aquired read-outs. Furthermore, it allows the
  visualization of user-defined metadata.

# Quick start

Here, we will highlight the most simple use of the package


Load the example data: SingleCellExperiment object
```{r quickstart-load-sce}
data(pancreasSCE)
pancreasSCE
```

Load the example data: List of images
```{r quickstart-load-IMCImageList}
data(pancreasImages)
pancreasImages
```

Load the example data: List of masks
```{r quickstart-load-masklist}
data(pancreasMasks)
pancreasMasks
```


## Quick plotting of pixel-level information
Illustration of the `plotPixel` function
```{r quickstart-plotpixels, fig.cap="Quick start: plot pixel-level information", fig.small=TRUE, echo=FALSE}
plotPixels(image=pancreasImages)
```

Displaying the cell masks.\n
Here, 'img_id' is used to match images and masks. The 'ImageNb' column is present in both 'mcols(pancreasImages)' and 'mcols(pancreasMasks)'
```{r quickstart-plotpixels-mask, fig.cap="Quick start: plot cell masks", fig.small=TRUE, echo=FALSE}
plotPixels(image=pancreasImages, mask=pancreasMasks, img_id = "ImageNb")
```

Plotting specific channels
```{r quickstart-plotpixels-twochannels, fig.cap="Quick start: plot specific channels", fig.small=TRUE, echo=FALSE}
plotPixels(image=pancreasImages, mask=pancreasMasks, img_id = "ImageNb", colour_by=c("H3","SMA"))
```


## Quick plotting of cell-level information
Illustration of the `plotCells` function
```{r quickstart-plotcells, fig.cap="Quick start: plot cell-level information", fig.small=TRUE, echo=FALSE}
plotCells(object=pancreasSCE, mask=pancreasMasks, img_id='ImageNb', cell_id='CellNb')
```

Colouring cells.\n
'colour_by' should be a column in 'colData(pancreasSCE)'\n
'expr_values' should be an assay in 'assays(pancreasSCE)'
```{r quickstart-plotcells-colourby, fig.cap="Quick start: colour by cell type", fig.small=TRUE, echo=FALSE}
plotCells(object=pancreasSCE, mask=pancreasMasks, img_id='ImageNb', cell_id='CellNb',
          colour_by="CellType", exprs_values="exprs")
```

Displaying cell outlines\n
'outline_by' should be a column in colData(pancreasSCE)
```{r quickstart-plotcells-outlineby, fig.cap="Quick start: outline by cell type", fig.small=TRUE, echo=FALSE}
plotCells(object=pancreasSCE, mask=pancreasMasks, img_id='ImageNb', cell_id='CellNb',
          outline_by="CellType")
```


# Data formats

IMCMapper combines objects of the `r Biocpkg("SingleCellExperiment")` class and the `IMCImageList` class `r Biocpkg("IMCMapper")` to visualize cell- and pixel-level information.

In the main functions of the package, `image` refers to an `IMCImageList` object containing one or multiple multi-channel images where each channel represents the pixel-intensity of one marker (protein, RNA, etc.).
The enrty `mask` refers to an `IMCImageList` object containing one or multiple segmentation masks.
Segmentation masks are defined as one-channel images containing integer values, which represent the cells' ids or 0 (background).
Finally, the `object` entry refers to a `SingleCellExperiment` class object that contains cell-specific expression values (in the `assay` slots) and cell-specific metadata in the `colData` slot.
For more information on the `SingleCellExperiment` object and how to create it, please see the `r Biocpkg("SingleCellExperiment")` package and the [Orchestrating Single-Cell Analysis with Bioconductor](https://osca.bioconductor.org/data-infrastructure.html#the-singlecellexperiment-class) workflow.

To link information between the `SingleCellExperiment` and `IMCImageList` objects, two slots need to be specified:

* `img_id`: a single character indicating the `colData` and `elementMetadata` entry that contains the image identifiers 
* `cell_id`: a single character indicating the `colData` entry that contains the cell identifiers. These should be integer values corresponing to pixel-values in the segmentation masks

To access the `elementMetadat` slot of an `IMCImageList` object, please refer to the section [The IMCImageList object](#IMCImageList).

# Reading in data

## Load images
Introduction to the `LoadImage` function

## Add metadata
```{r}
mcols(pancreasImages)
mcols(pancreasMasks)
colData(pancreasSCE)$ImageNb
```


# The IMCImageList object {#IMCImageList}

Images should be stacks, all stacks should have the same number of channels
Masks should be single-channel images

Explain mcols

## Accessors

## Coercion

## Subsetting
Extract one channel from the IMCImageList

## Looping

# Plotting pixel-level information

## Scaling

## Normalization

# Plotting Cell-level information

## Normalization

# Customization

## Legend

## Scale bar

## Cropping

# Saving images

# Acknowledgements

# Contributions

Nicolas created IMCMapper - Nicolas and Nils implemented the package ...

# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References

