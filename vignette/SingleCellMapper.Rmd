---
title: "SingleCellMapper for spatial data visualization in R"
author:
- name: Nils Eling
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nils.eling@dqbm.uzh.ch.com
- name: Nicolas Damond
  affiliation: Department for Quantitative Biomedicine, University of Zurich
  email: nicolas.damond@dqbm.uzh.ch.com
package: SingleCellMapper
output:
  BiocStyle::html_document
abstract: |
  This vignette should explain all functionality of SingleCellMapper. 
  Starting at how to read in images and cell-level information and prepare them 
  for visualization. Afterwards, we need to highlight all different use-cases of 
  the plotting functions.
vignette: |
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE)
library(BiocStyle)
set.seed(20200101)
library(SingleCellMapper)
```


# Introduction

This vignette gives an overview of spatial data visualization with the `SingleCellMapper` package.
This document also introduces the `ImageList` class, which inherits from the [`SimpleList` class](https://rdrr.io/bioc/S4Vectors/man/SimpleList-class.html).

Explain: images, masks, sce

# Quick start

Here, we will highlight the most simple use of the package


Load the example data: SingleCellExperiment object
```{r quickstart-load-sce}
data(pancreasSCE)
pancreasSCE
```

Load the example data: List of images
```{r quickstart-load-imagelist}
data(pancreasImages)
pancreasImages
```

Load the example data: List of masks
```{r quickstart-load-masklist}
data(pancreasMasks)
pancreasMasks
```


## Quick plotting of pixel-level information
Illustration of the `plotPixel` function
```{r quickstart-plotpixels, fig.cap="Quick start: plot pixel-level information", fig.small=TRUE, echo=FALSE}
plotPixels(image=pancreasImages)
```

Displaying the cell masks.\n
Here, 'img_id' is used to match images and masks. The 'ImageNb' column is present in both 'mcols(pancreasImages)' and 'mcols(pancreasMasks)'
```{r quickstart-plotpixels-mask, fig.cap="Quick start: plot cell masks", fig.small=TRUE, echo=FALSE}
plotPixels(image=pancreasImages, mask=pancreasMasks, img_id = "ImageNb")
```

Plotting specific channels
```{r quickstart-plotpixels-twochannels, fig.cap="Quick start: plot specific channels", fig.small=TRUE, echo=FALSE}
plotPixels(image=pancreasImages, mask=pancreasMasks, img_id = "ImageNb", colour_by=c("H3","SMA"))
```


## Quick plotting of cell-level information
Illustration of the `plotCells` function
```{r quickstart-plotcells, fig.cap="Quick start: plot cell-level information", fig.small=TRUE, echo=FALSE}
plotCells(object=pancreasSCE, mask=pancreasMasks, img_id='ImageNb', cell_id='CellNb')
```

Colouring cells.\n
'colour_by' should be a column in 'colData(pancreasSCE)'\n
'expr_values' should be an assay in 'assays(pancreasSCE)'
```{r quickstart-plotcells-colourby, fig.cap="Quick start: colour by cell type", fig.small=TRUE, echo=FALSE}
plotCells(object=pancreasSCE, mask=pancreasMasks, img_id='ImageNb', cell_id='CellNb',
          colour_by="CellType", exprs_values="exprs")
```

Displaying cell outlines\n
'outline_by' should be a column in colData(pancreasSCE)
```{r quickstart-plotcells-outlineby, fig.cap="Quick start: outline by cell type", fig.small=TRUE, echo=FALSE}
plotCells(object=pancreasSCE, mask=pancreasMasks, img_id='ImageNb', cell_id='CellNb',
          outline_by="CellType")
```


# Data formats

SingleCellMapper combines objects of the `r Biocpkg("SingleCellExperiment")` class and the `ImageList` class `r Biocpkg("SingleCellMapper")` to visualize cell- and pixel-level information.

In the main functions of the package, `image` refers to an `ImageList` object containing one or multiple multi-channel images where each channel represents the pixel-intensity of one marker (protein, RNA, etc.).
The enrty `mask` refers to an `ImageList` object containing one or multiple segmentation masks.
Segmentation masks are defined as one-channel images containing integer values, which represent the cells' ids or 0 (background).
Finally, the `object` entry refers to a `SingleCellExperiment` class object that contains cell-specific expression values (in the `assay` slots) and cell-specific metadata in the `colData` slot.
For more information on the `SingleCellExperiment` object and how to create it, please see the `r Biocpkg("SingleCellExperiment")` package and the [Orchestrating Single-Cell Analysis with Bioconductor](https://osca.bioconductor.org/data-infrastructure.html#the-singlecellexperiment-class) workflow.

To link information between the `SingleCellExperiment` and `ImageList` objects, two slots need to be specified:

* `img_id`: a single character indicating the `colData` and `elementMetadata` entry that contains the image identifiers 
* `cell_id`: a single character indicating the `colData` entry that contains the cell identifiers. These should be integer values corresponing to pixel-values in the segmentation masks

To access the `elementMetadat` slot of an `ImageList` object, please refer to the section [The ImageList object](#ImageList).

# Reading in data

## Load images
Introduction to the `LoadImage` function

## Add metadata
```{r}
mcols(pancreasImages)
mcols(pancreasMasks)
colData(pancreasSCE)$ImageNb
```


# The ImageList object {#ImageList}

Images should be stacks, all stacks should have the same number of channels
Masks should be single-channel images

Explain mcols

## Accessors

## Coercion

## Subsetting
Extract one channel from the ImageList

## Looping

# Plotting pixel-level information

## Scaling

## Normalization

# Plotting Cell-level information

## Normalization

# Customization

## Legend

## Scale bar

## Cropping

# Saving images

# Acknowledgements

# Contributions

Nicolas created SingleCellMapper - Nicolas and Nils implemented the package ...

# References

# Session info {.unnumbered}

```{r sessionInfo, echo=FALSE}
sessionInfo()
```


# Getting started

To enable the _Bioconductor_ style in your R Markdown vignette you need to include the following in the `DESCRIPTION` file:

    VignetteBuilder: knitr
    Suggests: BiocStyle, knitr, rmarkdown


# Style macros

_BiocStyle_ introduces the following macros for referring to _R_ packages:

* `r Biocpkg("IRanges")`, for _Bioconductor_ software, annotation and experiment data packages,
* `r CRANpkg("data.table")`, for _R_ packages available on CRAN,
* `r Githubpkg("rstudio/rmarkdown")`, for _R_ packages available on GitHub,
* `r Rpackage("MyPkg")`, for _R_ packages that are _not_ available on _Bioconductor_, CRAN or GitHub.


# Figures

Assign captions to figures in the code chunk option `fig.cap` to automatically number them, and to be able to reference them, see Figure \@ref(fig:plot). The figure label is generated from the code chunk label by prefixing it with `fig:`.

```{r plot, fig.cap="Regular figure. The first sentence of the figure caption is automatically emphasized to serve as figure title.", echo=FALSE}
plot(cars)
```

Small and wide figures can be specified by `fig.small` and `fig.wide` code chunk options.

```{r small, fig.cap="Small figure. A plot produced by a code chunk with option `fig.small = TRUE`.", fig.small=TRUE, echo=FALSE}
plot(cars)
```

```{r wide, fig.cap="Wide figure. A plot produced by a code chunk with option `fig.wide = TRUE`.", fig.wide=TRUE, echo=FALSE}
plot(cars)
```


# Equations

To number and reference equations, put them in equation environments and assign labels to them, see Equation \@ref(eq:binom).

\begin{equation}
  f\left(k\right) = \binom{n}{k} p^k\left(1-p\right)^{n-k}
  (\#eq:binom)
\end{equation}


# Tables

Like figures, tables with captions will also be numbered and can be referenced, see Table \@ref(tab:table).

Fruit   | Price
------- | -----
bananas | 1.2
apples  | 1.0
oranges | 2.5

: (\#tab:table) A simple table. With caption.


# Cross-references

Apart from referencing figures (Section \@ref(figures)), tables (Section \@ref(tables)), and equations (Section \@ref(equations)), you can also use the same syntax to refer to sections by their default labels generated by pandoc.


# Side notes

Footnotes are displayed as side notes on the right margin^[this is a side note entered as a footnote], which has the advantage that they appear close to the place where they are defined.

